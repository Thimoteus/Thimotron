(function(){var Jaraw,a,b,c,d,e,f;a=require("iced-runtime"),e=f=function(){},c=require("request"),d=require("./validate"),b=function(a){return a},Jaraw=function(){function Jaraw(a){switch("object"==typeof a?(d.isOptions(a),d.hasUserAgent(a)):(d.isUserAgent(a),a={type:"anon",user_agent:a}),a.type){case"script":d.isScript(a);break;case"web":d.isWebApp(a);break;case"installed":d.isInstalledApp(a)}"rate_limit"in a?a.rate_limit<2e3&&("anon"===a.type?a.rate_limit=2e3:a.rate_limit<1e3&&(a.rate_limit=1e3)):a.rate_limit=2e3,this.next_call=Date.now()+a.rate_limit,this.options=a}return Jaraw.prototype.loginAs=function(a,c){switch(null==c&&(c=b),a){case"script":return this.loginAsScript(c);case"web":return this.loginAsWeb(c);case"installed":return this.loginAsInstalled(c);default:throw new Error("incorrect login type")}},Jaraw.prototype.loginAsScript=function(d){var e,g,h,i,j,k,l,m,n;n=f,l=a.findDeferral(arguments),null==d&&(d=b),g=this.options.login,h=this.options.oauth,j=function(b){var d,e,i,j,k,l,m;m=f,k=a.findDeferral(arguments),i={url:"https://ssl.reddit.com/api/v1/access_token",method:"POST",form:{grant_type:"password",username:g.username,password:g.password},auth:{user:h.id,pass:h.secret}},function(){return function(b){l=new a.Deferrals(b,{parent:k,filename:"src/jaraw.iced"}),c(i,l.defer({assign_fn:function(){return function(){return d=arguments[0],e=arguments[1],j=arguments[2]}}(),lineno:54})),l._fulfill()}}(this)(function(){return function(){return b(d,j)}}(this))},i=function(a){return a=JSON.parse(a),a.expires_in=Date.now().valueOf()+1e3*a.expires_in,a},function(){return function(b){m=new a.Deferrals(b,{parent:l,filename:"src/jaraw.iced",funcname:"Jaraw.loginAsScript"}),j(m.defer({assign_fn:function(){return function(){return e=arguments[0],k=arguments[1]}}(),lineno:62})),m._fulfill()}}(this)(function(b){return function(){!function(c){return k?c(b.auth=i(k)):(console.log("Login attempt failed, trying again in 2 seconds"),void function(b){m=new a.Deferrals(b,{parent:l,filename:"src/jaraw.iced",funcname:"Jaraw.loginAsScript"}),setTimeout(m.defer({lineno:67}),2e3),m._fulfill()}(function(){!function(b){m=new a.Deferrals(b,{parent:l,filename:"src/jaraw.iced",funcname:"Jaraw.loginAsScript"}),loginAsScript(m.defer({lineno:68})),m._fulfill()}(c)}))}(function(){return d(b.auth)})}}(this))},Jaraw.prototype.call=function(b,e,g,h){var i,j,k,l,m,n,o,p,q,r;r=f,p=a.findDeferral(arguments),o=Date.now()-this.next_call,function(){return function(b){return 0>o?void!function(b){q=new a.Deferrals(b,{parent:p,filename:"src/jaraw.iced",funcname:"Jaraw.call"}),setTimeout(q.defer({lineno:73}),o),q._fulfill()}(b):b()}}(this)(function(o){return function(){d.isHTTPMethod(b),o.auth&&d.hasValidAuth(o.auth),"function"==typeof g&&(h=g,g={}),m="get"===b.toLowerCase()?{qs:g}:{form:g},m.url=o.options.oauth?"https://oauth.reddit.com":"https://www.reddit.com",m.url+=e,k=function(d){var e,g,h,i,j,k,l;l=f,j=a.findDeferral(arguments),h={"User-Agent":o.options.user_agent},o.auth&&(h.Authorization="bearer "+o.auth.access_token),m.headers=h,function(d){k=new a.Deferrals(d,{parent:j,filename:"src/jaraw.iced"}),c[b.toLowerCase()](m,k.defer({assign_fn:function(){return function(){return g=arguments[0],i=arguments[1],e=arguments[2]}}(),lineno:93})),k._fulfill()}(function(){return d(g,i,e)})},function(b){q=new a.Deferrals(b,{parent:p,filename:"src/jaraw.iced",funcname:"Jaraw.call"}),k(q.defer({assign_fn:function(){return function(){return l=arguments[0],n=arguments[1],j=arguments[2]}}(),lineno:96})),q._fulfill()}(function(){!function(b){var c;return 401!==(c="undefined"!=typeof n&&null!==n?n.statusCode:void 0)&&403!==c?b():void!function(b){q=new a.Deferrals(b,{parent:p,filename:"src/jaraw.iced",funcname:"Jaraw.call"}),o.loginAs(o.options.type,q.defer({assign_fn:function(){return function(){return i=arguments[0]}}(),lineno:99})),q._fulfill()}(function(){!function(b){q=new a.Deferrals(b,{parent:p,filename:"src/jaraw.iced",funcname:"Jaraw.call"}),k(q.defer({assign_fn:function(){return function(){return l=arguments[0],n=arguments[1],j=arguments[2]}}(),lineno:100})),q._fulfill()}(function(){return b(l?void 0:o.next_call=Date.now()+o.options.rate_limit)})})}(function(){return h(l,n,j)})})}}(this))},Jaraw.prototype.get=function(a,c,d){return null==c&&(c={}),null==d&&(d=b),this.call("get",a,c,d)},Jaraw.prototype.post=function(a,c,d){return null==c&&(c={}),null==d&&(d=b),this.call("post",a,c,d)},Jaraw.prototype.logout=function(d){var e,g,h,i,j,k,l;l=f,j=a.findDeferral(arguments),null==d&&(d=b),h={url:"https://ssl.reddit.com/api/v1/revoke_token",method:"POST",auth:{user:this.options.oauth.id,pass:this.options.oauth.secret},form:{token:this.auth.access_token,token_type_hint:"access_token"}},function(){return function(b){k=new a.Deferrals(b,{parent:j,filename:"src/jaraw.iced",funcname:"Jaraw.logout"}),c(h,k.defer({assign_fn:function(){return function(){return e=arguments[0],i=arguments[1],g=arguments[2]}}(),lineno:119})),k._fulfill()}}(this)(function(){return function(){return console.log("Logged out!"),d(e,i,g)}}(this))},Jaraw}(),module.exports=Jaraw}).call(this);