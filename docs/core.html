<!DOCTYPE html>

<html>
<head>
  <title>core.ls</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="bailiff.html">
                  bailiff.ls
                </a>
              
                
                <a class="source" href="core.html">
                  core.ls
                </a>
              
                
                <a class="source" href="image-scraper.html">
                  image-scraper.ls
                </a>
              
                
                <a class="source" href="library.html">
                  library.ls
                </a>
              
                
                <a class="source" href="mail.html">
                  mail.ls
                </a>
              
                
                <a class="source" href="search.html">
                  search.ls
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>core.ls</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-built_in">global</span> &lt;&lt;&lt; <span class="hljs-built_in">require</span> <span class="hljs-string">'prelude-ls'</span>
Jaraw = <span class="hljs-built_in">require</span> <span class="hljs-string">'jaraw'</span>
mongo = <span class="hljs-built_in">require</span> <span class="hljs-string">'mongojs'</span>

<span class="hljs-reserved">const</span> settings = <span class="hljs-built_in">require</span> <span class="hljs-string">'../../settings'</span>
<span class="hljs-reserved">const</span> db-name = settings.db.name <span class="hljs-keyword">or</span> <span class="hljs-string">'bot'</span>
<span class="hljs-reserved">const</span> db-collections = &lt;[ mentions receivedPms acknowledgedPms bailiffCases bailiffEvidence ]&gt;
<span class="hljs-reserved">const</span> db = mongo db-name, db-collections

<span class="hljs-reserved">const</span> user-agent = <span class="hljs-string">"<span class="hljs-subst">#{settings.info.name}</span>@<span class="hljs-subst">#{settings.info.version <span class="hljs-keyword">or</span> <span class="hljs-string">'1.0.0'</span>}</span> by <span class="hljs-subst">#{settings.info.author <span class="hljs-keyword">or</span> <span class="hljs-string">''</span>}</span>"</span>
<span class="hljs-reserved">const</span> username = settings.login.username
<span class="hljs-reserved">const</span> password = settings.login.password
<span class="hljs-reserved">const</span> client-id = settings.oauth.client_id
<span class="hljs-reserved">const</span> secret = settings.oauth.client_secret
<span class="hljs-reserved">const</span> recipient = settings.recipient
<span class="hljs-reserved">const</span> talkative = settings.verbose <span class="hljs-keyword">or</span> <span class="hljs-literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Jaraw lets us access the reddit API
with a minimum of hassle.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>robot = <span class="hljs-keyword">new</span> Jaraw <span class="hljs-keyword">do</span>
   <span class="hljs-attribute">type</span>: \script
   <span class="hljs-attribute">login</span>:
      <span class="hljs-attribute">username</span>: username
      <span class="hljs-attribute">password</span>: password
   <span class="hljs-attribute">oauth</span>:
      <span class="hljs-attribute">id</span>: client-id
      <span class="hljs-attribute">secret</span>: secret
   <span class="hljs-attribute">user_agent</span>: user-agent
   <span class="hljs-attribute">rate_limit</span>: <span class="hljs-number">1</span>_000ms</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>console.log for debugging</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">say</span> = -&gt;</span> <span class="hljs-built_in">console</span>.log it <span class="hljs-keyword">if</span> talkative</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>basic login function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">login</span> = <span class="hljs-params">(cb)</span> -&gt;</span>
   say <span class="hljs-string">"#username is initializing"</span>
   robot.login-as-script cb</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>takes a number <code>t</code> of milliseconds, <code>f</code> a function, <code>n</code> a string describing <code>f</code>, optional arguments and repeats <code>f</code> every <code>t</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">repeat</span> = <span class="hljs-params">(t, f, n, ...args)</span> -&gt;</span>
<span class="hljs-function">   <span class="hljs-title">fn</span> = -&gt;</span>
      set-timeout fn, t
      say <span class="hljs-string">"Beginning new loop for #n"</span>
      f ...args
   fn!</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>takes a regular expression and a string and returns an array of all matches in the string</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>recurse-through-re = (re, str) --&gt;
   flag = <span class="hljs-string">'g'</span>
   flag += <span class="hljs-string">'i'</span> <span class="hljs-keyword">if</span> re.ignore-<span class="hljs-reserved">case</span>
   flag += <span class="hljs-string">'m'</span> <span class="hljs-keyword">if</span> re.multiline
   rx = <span class="hljs-keyword">new</span> RegExp re.source, flag
   ret = []
   <span class="hljs-keyword">while</span> hit = rx.exec str
      ret.push hit<span class="hljs-number">.1</span>
   <span class="hljs-keyword">return</span> ret</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>applies JSON.parse when possible, otherwise is the identity</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">JSONparse</span> = -&gt;</span>
   <span class="hljs-keyword">try</span>
      b = JSON.parse it
      <span class="hljs-keyword">return</span> b
   <span class="hljs-keyword">catch</span>
      <span class="hljs-keyword">if</span> e <span class="hljs-keyword">instanceof</span> SyntaxError
         <span class="hljs-keyword">return</span> it
      <span class="hljs-keyword">else</span>
         <span class="hljs-keyword">throw</span> e</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>useful for simplifying “list” responses from reddit</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>simplify-listing = JSONparse &gt;&gt; (.data.children) &gt;&gt; map (.data)</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>takes an array and inserts each element into <code>db-collection</code>, unless that element is already in (based on a .name attribute)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>commit-array-to-db = <span class="hljs-function"><span class="hljs-params">(array, collection, cb = id)</span> -&gt;</span>
   arr = []
   <span class="hljs-keyword">if</span> array.length &gt; <span class="hljs-number">0</span>
      (element, i) &lt;- array.forEach
      (exists) &lt;- check-<span class="hljs-keyword">if</span>-element-<span class="hljs-keyword">in</span>-db element, collection
      <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> exists
         db[collection].insert element
         say <span class="hljs-string">"inserted <span class="hljs-subst">#{element.name}</span> to database #collection"</span>
         arr.push element
      <span class="hljs-keyword">if</span> i == array.length - <span class="hljs-number">1</span> =&gt; <span class="hljs-keyword">return</span> cb arr
   <span class="hljs-keyword">else</span>
      <span class="hljs-keyword">return</span> cb arr</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>returns true if <code>el</code> is in <code>collection</code> of the database, otherwise false</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>check-<span class="hljs-keyword">if</span>-element-<span class="hljs-keyword">in</span>-db = <span class="hljs-function"><span class="hljs-params">(el, collection, cb = id)</span> -&gt;</span>
   db[collection].find <span class="hljs-attribute">name</span>: el.name .limit <span class="hljs-number">1</span> .count (err, count) -&gt;
      ret = count != <span class="hljs-number">0</span>
      cb ret</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>sends a reply to <code>dest</code> with message <code>text</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>reply-to = <span class="hljs-function"><span class="hljs-params">(dest, text)</span> -&gt;</span>
   params =
      <span class="hljs-attribute">thing_id</span>: dest
      <span class="hljs-attribute">text</span>: text
      <span class="hljs-attribute">api_type</span>: <span class="hljs-string">'json'</span>
   robot.post <span class="hljs-string">"/api/comment"</span>, params, <span class="hljs-function"><span class="hljs-params">(err, res, bod)</span> -&gt;</span>
      <span class="hljs-keyword">if</span> err <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> res =&gt; <span class="hljs-keyword">return</span> say <span class="hljs-string">"Something went wrong, reply-to"</span>
      <span class="hljs-keyword">if</span> res.status-code <span class="hljs-keyword">isnt</span> <span class="hljs-number">200</span> =&gt; <span class="hljs-keyword">return</span> say <span class="hljs-string">"Something went wrong: <span class="hljs-subst">#{res.status-code}</span>, reply-to"</span>
      <span class="hljs-keyword">return</span> say <span class="hljs-string">"Reply sent:\nDest: #dest\nText: #text"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>sends a pm with subject <code>title</code> to <code>receiver</code> with message <code>body</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>send-pm = <span class="hljs-function"><span class="hljs-params">(title, body, receiver)</span> -&gt;</span>
   <span class="hljs-keyword">if</span> <span class="hljs-regexp">/\/u\//</span>.test receiver =&gt; receiver = unchars receiver[<span class="hljs-number">3</span> to]
   params =
      <span class="hljs-attribute">api_type</span>: <span class="hljs-string">'json'</span>
      <span class="hljs-attribute">subject</span>: title
      <span class="hljs-attribute">text</span>: body
      <span class="hljs-attribute">to</span>: receiver
   robot.post <span class="hljs-string">"/api/compose"</span>, params, <span class="hljs-function"><span class="hljs-params">(err, res, bod)</span> -&gt;</span>
      <span class="hljs-keyword">if</span> err <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> res =&gt; <span class="hljs-keyword">return</span> say <span class="hljs-string">"Something went wrong, send-pm"</span>
      <span class="hljs-keyword">if</span> res.status-code <span class="hljs-keyword">isnt</span> <span class="hljs-number">200</span> =&gt; <span class="hljs-keyword">return</span> say <span class="hljs-string">"Something went wrong: <span class="hljs-subst">#{res.status-code}</span>, send-pm"</span>
      <span class="hljs-keyword">return</span> say <span class="hljs-string">"PM sent:\nRecipient: #receiver\nTitle: #title\nBody: #body"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>where the magic happens</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-built_in">module</span>.exports =
   <span class="hljs-attribute">login</span>: login
   <span class="hljs-attribute">recipient</span>: recipient
   send-<span class="hljs-attribute">pm</span>: send-pm
   reply-<span class="hljs-attribute">to</span>: reply-to
   commit-array-to-<span class="hljs-attribute">db</span>: commit-array-to-db
   recurse-through-<span class="hljs-attribute">re</span>: recurse-through-re
   simplify-<span class="hljs-attribute">listing</span>: simplify-listing
   <span class="hljs-attribute">repeat</span>: repeat
   <span class="hljs-attribute">say</span>: say
   <span class="hljs-attribute">robot</span>: robot
   <span class="hljs-attribute">db</span>: db
   check-<span class="hljs-keyword">if</span>-element-<span class="hljs-keyword">in</span>-<span class="hljs-attribute">db</span>: check-<span class="hljs-keyword">if</span>-element-<span class="hljs-keyword">in</span>-db</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
